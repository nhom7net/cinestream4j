<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .movie-poster {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .movie-details {
            padding: 20px;
        }

        .rating {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .section-title {
            margin-top: 20px;
            font-weight: bold;
            font-size: 1.5rem;
            color: #333;
        }

        .cast-card {
            text-align: center;
            cursor: pointer;
        }

        .cast-card img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;

        }

        .movie-poster {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .production-company-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-right: 10px;
            border-radius: 5px;
            transition: transform 0.2s ease-in-out;
        }

        .production-company-logo:hover {
            transform: scale(1.1);
        }

        .production-company-info {
            font-size: 0.9rem;
        }

        .btnAddToList {
            background-color: #f59e0b;
            color: white;
            border-radius: 0.25rem;
            width: 200px;
            height: 2.5rem;
            transition: background-color 0.3s ease;
        }

        .btnAddToList:hover {
            background-color: #b45309;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <div id="movie-container" class="row">
        <!-- Movie Details s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
    </div>

    <!-- Cast Section -->
    <div class="mt-5">
        <h2 class="section-title text-center">üé≠ Danh S√°ch Di·ªÖn Vi√™n</h2>
        <div id="cast-container" class="row">
            <!-- Danh s√°ch di·ªÖn vi√™n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </div>
    </div>
</div>

<script>
    const API_KEY = '5b3554c90c5c911c652788f8b65db269';

    // L·∫•y movieId t·ª´ URL
    const urlParams = new URLSearchParams(window.location.search);
    const movieId = urlParams.get('movieId');
    // L·∫•y tham s·ªë ng√¥n ng·ªØ t·ª´ URL
    const params = new URLSearchParams(window.location.search);
    const lang = params.get('lang') || 'vi'; // M·∫∑c ƒë·ªãnh l√† 'vi'

    // G·ªçi API l·∫•y th√¥ng tin chi ti·∫øt phim
    const apiUrl = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${API_KEY}&language=${lang}&append_to_response=videos`;
    const castApiUrl = `https://api.themoviedb.org/3/movie/${movieId}/credits?api_key=${API_KEY}&language=${lang}`;

    async function fetchMovieDetails() {
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin phim');
            }

            const movie = await response.json();
            displayMovieDetails(movie);
        } catch (error) {
            console.error('L·ªói khi l·∫•y th√¥ng tin phim:', error);
            document.getElementById('movie-container').innerHTML = '<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin phim.</p>';
        }
    }

    async function fetchCast() {
        try {
            const response = await fetch(castApiUrl);
            if (!response.ok) {
                throw new Error('Kh√¥ng th·ªÉ l·∫•y danh s√°ch di·ªÖn vi√™n');
            }

            const data = await response.json();
            displayCast(data.cast);
        } catch (error) {
            console.error('L·ªói khi l·∫•y danh s√°ch di·ªÖn vi√™n:', error);
            document.getElementById('cast-container').innerHTML = '<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i danh s√°ch di·ªÖn vi√™n.</p>';
        }
    }

    // Hi·ªÉn th·ªã th√¥ng tin phim
    function displayMovieDetails(movie) {
        const container = document.getElementById('movie-container');

        // T·∫°o danh s√°ch c√°c h√£ng phim v·ªõi li√™n k·∫øt ƒëi·ªÅu h∆∞·ªõng
        const productionCompanies = movie.production_companies?.map(company => `
        <div class="d-flex align-items-center mb-2">
            <a href="/company?companyId=${company.id}" target="_self" style="text-decoration: none; color: inherit;">
                <img src="https://image.tmdb.org/t/p/w200${company.logo_path}"
                     alt="${company.name}"
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/50';"
                     class="production-company-logo">
                <strong>${company.name}</strong>
                <small>(${company.origin_country || 'N/A'})</small>
            </a>
        </div>
    `).join('') || '<p>Kh√¥ng c√≥ th√¥ng tin c√¥ng ty s·∫£n xu·∫•t.</p>';

        // L·∫•y video trailer ƒë·∫ßu ti√™n n·∫øu c√≥
        const trailer = movie.videos?.results.find(video => video.type === "Trailer" && video.site === "YouTube");

        container.innerHTML = `
        <div class="col-md-4">
            <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" alt="${movie.title}" class="movie-poster">
            <div class="mt-4">
                <h5>C√¥ng ty s·∫£n xu·∫•t:</h5>
                ${productionCompanies}
            </div>
        </div>
        <div class="col-md-8 movie-details">
            <h1>${movie.title}</h1>
            <p><strong>Kh·∫©u hi·ªáu:</strong> ${movie.tagline || 'Kh√¥ng c√≥ kh·∫©u hi·ªáu.'}</p>
            <p><strong>Ng√†y ph√°t h√†nh:</strong> ${movie.release_date}</p>
            <p><strong>M√¥ t·∫£:</strong> ${movie.overview || 'Kh√¥ng c√≥ m√¥ t·∫£.'}</p>
            <p class="rating"><strong>ƒê√°nh gi√°:</strong> ${movie.vote_average} / 10 (${movie.vote_count} l∆∞·ª£t)</p>
            <p><strong>Th·ªÉ lo·∫°i:</strong> ${movie.genres.map(genre => genre.name).join(', ')}</p>
            <p><strong>Th·ªùi l∆∞·ª£ng:</strong> ${movie.runtime} ph√∫t</p>
            <p><strong>Ng√¥n ng·ªØ g·ªëc:</strong> ${movie.original_language.toUpperCase()}</p>
            <p><strong>Qu·ªëc gia s·∫£n xu·∫•t:</strong> ${movie.production_countries.map(country => country.name).join(', ')}</p>
            <p><strong>Doanh thu:</strong> $${movie.revenue.toLocaleString()}</p>
            <p><strong>Ng√¢n s√°ch:</strong> $${movie.budget.toLocaleString()}</p>
            <p><strong>Tr·∫°ng th√°i:</strong> ${movie.status}</p>
            <p><strong>Trang web ch√≠nh th·ª©c:</strong>
                ${movie.homepage ? `<a href="${movie.homepage}" target="_blank">${movie.homepage}</a>` : 'Kh√¥ng c√≥'}
            </p>
            <button class="btnAddToList" onclick="addToList()">Th√™m v√†o danh s√°ch</button>
            ${trailer ? `<p class="section-title">üé¨ Trailer:</p>
            <iframe width="100%" height="315" src="https://www.youtube.com/embed/${trailer.key}" frameborder="0" allowfullscreen></iframe>` : ''}
        </div>
    `;
    }

    // Hi·ªÉn th·ªã danh s√°ch di·ªÖn vi√™n
    function displayCast(cast) {
        const container = document.getElementById('cast-container');
        container.innerHTML = '';

        if (!cast || cast.length === 0) {
            container.innerHTML = '<p class="text-center">Kh√¥ng c√≥ th√¥ng tin di·ªÖn vi√™n.</p>';
            return;
        }

        cast.slice(0, 12).forEach(actor => {
            const actorCard = document.createElement('div');
            actorCard.className = 'col-md-2 mb-4 cast-card';
            actorCard.innerHTML = `
                <img src="https://image.tmdb.org/t/p/w200${actor.profile_path}" alt="${actor.name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/100';">
                <h6>${actor.name}</h6>
                <p><small>${actor.character || 'N/A'}</small></p>
            `;
            actorCard.addEventListener('click', () => {
                window.location.href = `/cast?personId=${actor.id}`;
            });
            container.appendChild(actorCard);
        });
    }

    // G·ªçi h√†m khi t·∫£i trang
    fetchMovieDetails();
    fetchCast();

    // H√†m th√™m phim v√†o danh s√°ch phim
    async function addToList() {
        // L·∫•y URL hi·ªán t·∫°i ƒë·ªÉ x√°c ƒë·ªãnh phim mu·ªën th√™m
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('movieId');

        console.log(movieId);
        try {
            const data = JSON.stringify({
                movieId: movieId
            });

            // G·ª≠i request t·ªõi endpoint ƒë·ªÉ th√™m phim
            const response = await fetch(`/watchlist/add`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: data
            });
            console.log(data);
            console.log(response);

            const result = await response.json();
            console.log(result);

            if (response.ok) {
                alert(result.message);
            } else {
                const errorData = await response.json();
                alert('Th√™m phim kh√¥ng th√†nh c√¥ng: ' + errorData.message);
            }
        } catch (error) {
            console.error('L·ªói khi th√™m v√†o danh s√°ch:', error);
            alert('ƒê√£ x·∫£y ra l·ªói, vui l√≤ng th·ª≠ l·∫°i.');
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
