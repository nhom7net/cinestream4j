<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Danh s√°ch xem</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div th:replace="components/header :: header"></div>

<div class="container mt-5">
    <h2>üì∫ Danh s√°ch phim ƒë√£ l∆∞u</h2>

    <!-- Hi·ªÉn th·ªã l·ªói n·∫øu c√≥ -->
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <!-- Ki·ªÉm tra danh s√°ch r·ªóng -->
    <div th:if="${#lists.isEmpty(watchlist)}" class="alert alert-info">
        B·∫°n ch∆∞a th√™m phim n√†o v√†o danh s√°ch.
    </div>

    <!-- Hi·ªÉn th·ªã danh s√°ch phim -->
    <div th:if="${!#lists.isEmpty(watchlist)}" class="row">
        <div class="col-md-3 mb-4" th:each="movie : ${watchlist}">
            <div class="card">
                <!-- H√¨nh ·∫£nh poster -->
                <img th:src="'https://image.tmdb.org/t/p/w500' + ${movie.poster_path}" class="card-img-top" src="" alt="Poster phim">

                <div class="card-body">
                    <!-- T√™n phim -->
                    <h5 class="card-title" th:text="${movie.title}">ƒêang t·∫£i...</h5>

                    <!-- N√∫t h√†nh ƒë·ªông -->
                    <a th:href="@{'/details?movieId=' + ${movie.id}}" class="btn btn-primary btn-sm">Xem chi ti·∫øt</a>
                    <button class="btn btn-danger btn-sm" th:attr="onclick=|removeFromList('${movie.id}')|">X√≥a</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-3">
    <!-- Hi·ªÉn th·ªã th√¥ng b√°o l·ªói -->
    <div th:if="${alertMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${alertMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Hi·ªÉn th·ªã th√¥ng b√°o l·ªói -->
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Hi·ªÉn th·ªã th√¥ng b√°o th√¥ng tin -->
    <div th:if="${infoMessage}" class="alert alert-info alert-dismissible fade show" role="alert">
        <span th:text="${infoMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>

<!-- X·ª≠ l√Ω x√≥a phim kh·ªèi danh s√°ch -->
<script>
    const API_KEY = '5b3554c90c5c911c652788f8b65db269';

    async function removeFromList(movieId) {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phim n√†y kh·ªèi danh s√°ch?")) {
            try {
                const response = await fetch('/watchlist/remove', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({movieId: movieId})
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('L·ªói:', error);
                alert('ƒê√£ x·∫£y ra l·ªói khi x√≥a phim.');
            }
        }
    }

    // Fetch th√¥ng tin phim t·ª´ API
    async function fetchMovies(movieId) {
        const URL = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${API_KEY}&language=${lang}`;

        try {
            const response = await fetch(URL);

            if (!response.ok) {
                console.error(`L·ªói API v·ªõi movieId: ${movieId}, status: ${response.status}`);
                return;
            }

            const data = await response.json();
            console.log("data: ", data);

            // C·∫≠p nh·∫≠t h√¨nh ·∫£nh v√† ti√™u ƒë·ªÅ phim
            document.getElementById(`poster-${movieId}`).src = `https://image.tmdb.org/t/p/w500${data.poster_path}`;
            document.getElementById(`title-${movieId}`).innerText = data.title;
        } catch (error) {
            console.error('L·ªói khi t·∫£i th√¥ng tin phim:', error);
        }
    }

    // T·ª± ƒë·ªông fetch th√¥ng tin t·∫•t c·∫£ phim trong danh s√°ch
    document.addEventListener('DOMContentLoaded', () => {
        const movieIds = /*[[${watchlist}]]*/ [];
        console.log("Danh s√°ch movieIds: ", movieIds);

        movieIds.forEach(item => {
            console.log("Fetching movieId: ", item.movieId);
            fetchMovies(item.movieId);
        });
    });
</script>

</body>
</html>
